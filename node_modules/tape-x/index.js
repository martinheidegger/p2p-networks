const tape = require('tape')
const path = require('path')

module.exports = function createTest () {
  const lines = new Error().stack.split('\n')
  const relevantLine = lines[2]
  const location = /\(([^\)]*)\)/ig.exec(relevantLine)[1]
  let file = location.split(':')[0]
  if (/\.js$/.test(file)) {
    file = file.substr(0, file.length - 3)
  }
  file = path.relative(process.cwd(), file)
  return function test (name, op, final) {
    tape(`${file} > ${name}`, t => {
      const _end = t.end
      if (final) {
        t.end = function () {
          final()
          _end.apply(this, arguments)
        }
      }
      let res = op(t)
      if (res) {
        t.end = _end
        if (final) {
          res = res
            .catch(err => {
              final()
              return Promise.reject(err)
            })
            .then(final)
        }
        res
          .catch(err => {
            console.log(err.stack)
            t.fail(err)
          })
          .then(() => {
            t.end = _end
            t.end()
          })
      }
    })
  }
}
