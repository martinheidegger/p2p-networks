const tape = require('tape')
const path = require('path')

module.exports = function createTest () {
  const lines = new Error().stack.split('\n')
  const relevantLine = lines[2]
  const location = /\(([^\)]*)\)/ig.exec(relevantLine)[1]
  let file = location.split(':')[0]
  if (/\.js$/.test(file)) {
    file = file.substr(0, file.length - 3)
  }
  file = path.relative(process.cwd(), file)
  return function test (name, op) {
    tape(`${file} > ${name}`, t => {
      const res = op(t)
      if (res) {
        res
          .catch(err => t.fail(err))
          .then(() => t.end())
      }
    })
  }
}
